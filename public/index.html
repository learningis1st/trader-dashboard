<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #1a1a1a;
            color: #e5e5e5;
        }
        
        .grid-stack-item-content {
            background-color: #262626 !important;
            border: 1px solid #404040; 
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            height: 100%; 
            transition: border-color 0.2s;
        }

        .grid-stack-item-content:hover {
            border-color: #525252;
        }
        
        .grid-stack-item-content:hover .remove-btn {
            opacity: 1;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        .widget-container {
            container-type: size;
        }

        .responsive-symbol {
            font-size: clamp(14px, 15cqmin, 100px);
            line-height: 1.2;
        }

        .responsive-price {
            font-size: clamp(24px, 30cqmin, 200px);
            line-height: 1;
            padding: 0 4px; /* Padding for the background flash */
            border-radius: 4px; /* Rounded corners for the flash */
        }

        .responsive-detail {
            font-size: clamp(10px, 10cqmin, 60px);
            line-height: 1.2;
        }

        /* --- FLASH ANIMATIONS --- */
        @keyframes flashGreen {
            0% { background-color: rgba(74, 222, 128, 0.5); color: white; }
            100% { background-color: transparent; }
        }
        @keyframes flashRed {
            0% { background-color: rgba(248, 113, 113, 0.5); color: white; }
            100% { background-color: transparent; }
        }

        .flash-up {
            animation: flashGreen 0.7s ease-out;
        }
        .flash-down {
            animation: flashRed 0.7s ease-out;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">

    <div class="grid-stack p-4"></div>

    <div id="magic-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl border border-gray-700 w-96">
            <label class="block text-gray-400 text-sm font-bold mb-2">ADD SYMBOL</label>
            <input type="text" id="symbol-input" 
                class="w-full bg-gray-900 text-white border border-gray-600 rounded p-3 text-2xl uppercase focus:outline-none focus:border-blue-500 placeholder-gray-600"
                placeholder="AAPL" autocomplete="off">
            <div class="mt-2 text-xs text-gray-500">Press ENTER to add, ESC to cancel</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>

    <script>
        const WORKER_URL = 'https://finance.learningis1.st';
        const REFRESH_RATE = 1000; 
        
        let grid = null;
        let symbolList = [];
        let previousPrices = {}; // Stores last known price for flashing logic

        document.addEventListener('DOMContentLoaded', () => {
            grid = GridStack.init({
                float: true,
                cellHeight: 100,
                minRow: 1,
                margin: 10, 
                column: 12,
                disableOneColumnMode: true
            });

            loadState();
            fetchData();
            setInterval(fetchData, REFRESH_RATE);
            setupMagicInput();

            grid.on('change', saveState);
        });

        function setupMagicInput() {
            const modal = document.getElementById('magic-modal');
            const input = document.getElementById('symbol-input');

            document.addEventListener('keydown', (e) => {
                if (e.key === '`') {
                    e.preventDefault();
                    modal.classList.remove('hidden');
                    input.value = '';
                    input.focus();
                }
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const rawVal = input.value.trim().toUpperCase();
                    if (rawVal) {
                        addSymbolWidget(rawVal);
                        modal.classList.add('hidden');
                        fetchData();
                    }
                }
            });
        }

        function addSymbolWidget(symbol, node = null) {
            if (symbolList.includes(symbol)) return;
            symbolList.push(symbol);

            const widgetHtml = `
                <div class="h-full w-full p-4 flex flex-col justify-between relative group widget-container" id="widget-${symbol}">
                    <div class="flex justify-between items-start">
                        <span class="responsive-symbol font-bold text-gray-100 cursor-pointer hover:text-blue-400 transition-colors" 
                              onclick="editTicker('${symbol}', this)" 
                              title="Click to edit">${symbol}</span>
                        <button onclick="removeSymbol('${symbol}')" class="remove-btn opacity-0 transition-opacity text-gray-400 hover:text-red-500 p-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="flex-grow flex items-center justify-center">
                        <span class="responsive-price font-mono font-bold text-gray-300 tracking-tighter" id="price-${symbol}">---</span>
                    </div>
                    
                    <div class="flex justify-between items-end font-medium">
                        <span id="chg-${symbol}" class="responsive-detail text-gray-500">--</span>
                        <span id="pct-${symbol}" class="responsive-detail text-gray-500">--%</span>
                    </div>
                </div>
            `;

            const options = node || { w: 3, h: 2, x: 0, y: 0 };
            
            grid.addWidget({
                ...options,
                content: widgetHtml,
                id: symbol 
            });

            saveState();
        }

        window.removeSymbol = function(symbol) {
            const el = document.getElementById(`widget-${symbol}`).closest('.grid-stack-item');
            grid.removeWidget(el);
            symbolList = symbolList.filter(s => s !== symbol);
            delete previousPrices[symbol]; // Cleanup history
            saveState();
        };

        window.editTicker = function(oldSymbol, el) {
            // Create the input element to replace the span
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldSymbol;
            input.className = 'bg-gray-700 text-white responsive-symbol font-bold w-[50cqmin] px-1 rounded border border-blue-500 uppercase focus:outline-none';
            
            const parent = el.parentNode;
            
            const finish = () => {
                const newSymbol = input.value.trim().toUpperCase();
                
                // If cancelled, empty, or unchanged -> Revert to text
                if (!newSymbol || newSymbol === oldSymbol) {
                    parent.replaceChild(el, input);
                    return;
                }

                // Prevent duplicates
                if (symbolList.includes(newSymbol)) {
                    alert(`Symbol ${newSymbol} is already on the dashboard.`);
                    parent.replaceChild(el, input);
                    return;
                }

                // Proceed with replacement
                // 1. Get geometry of current widget
                const widgetEl = document.getElementById(`widget-${oldSymbol}`).closest('.grid-stack-item');
                const node = widgetEl.gridstackNode;
                
                if (node) {
                    const options = { x: node.x, y: node.y, w: node.w, h: node.h };
                    
                    // 2. Remove old widget logic
                    grid.removeWidget(widgetEl);
                    symbolList = symbolList.filter(s => s !== oldSymbol);
                    delete previousPrices[oldSymbol]; // Cleanup old symbol history
                    
                    // 3. Add new widget with same geometry
                    addSymbolWidget(newSymbol, options);
                    
                    // 4. Trigger fetch immediately
                    fetchData();
                } else {
                    parent.replaceChild(el, input);
                }
            };

            // Handle Input Events
            input.addEventListener('blur', finish);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur(); // Trigger finish
                } else if (e.key === 'Escape') {
                    input.value = oldSymbol; // Reset to ensure revert
                    input.blur();
                }
            });

            // Swap and focus
            parent.replaceChild(input, el);
            input.focus();
            input.select();
        };

        async function fetchData() {
            if (symbolList.length === 0) return;

            try {
                const symbolsParam = symbolList.join(',');
                const response = await fetch(`${WORKER_URL}/quote?symbol=${symbolsParam}&fields=quote`);
                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error("Fetch failed:", error);
            }
        }

        function updateUI(data) {
            Object.keys(data).forEach(symbol => {
                const quote = data[symbol].quote;
                if (!quote) return;

                const priceEl = document.getElementById(`price-${symbol}`);
                const chgEl = document.getElementById(`chg-${symbol}`);
                const pctEl = document.getElementById(`pct-${symbol}`);

                if (priceEl && chgEl && pctEl) {
                    const currentPrice = quote.lastPrice;
                    
                    // Check for price change and trigger flash
                    const oldPrice = previousPrices[symbol];
                    if (oldPrice !== undefined && currentPrice !== oldPrice) {
                        // Remove existing classes to reset animation if it's currently running
                        priceEl.classList.remove('flash-up', 'flash-down');
                        
                        // Force reflow
                        void priceEl.offsetWidth; 

                        // Add new class based on direction
                        if (currentPrice > oldPrice) {
                            priceEl.classList.add('flash-up');
                        } else {
                            priceEl.classList.add('flash-down');
                        }

                        // Remove class after animation finishes
                        setTimeout(() => {
                            priceEl.classList.remove('flash-up', 'flash-down');
                        }, 700);
                    }
                    
                    // Update state
                    previousPrices[symbol] = currentPrice;

                    // Update Text
                    priceEl.innerText = quote.lastPrice.toFixed(2);
                    chgEl.innerText = (quote.netChange > 0 ? '+' : '') + quote.netChange.toFixed(2);
                    pctEl.innerText = (quote.netPercentChange > 0 ? '+' : '') + quote.netPercentChange.toFixed(2) + '%';

                    // Update Static Colors (Daily Change)
                    const colorClass = quote.netChange >= 0 ? 'text-[#4ade80]' : 'text-[#f87171]';
                    
                    [priceEl, chgEl, pctEl].forEach(el => {
                        el.classList.remove('text-[#4ade80]', 'text-[#f87171]', 'text-gray-300', 'text-gray-500');
                        el.classList.add(colorClass);
                    });
                }
            });
        }

        function saveState() {
            const layout = [];
            grid.engine.nodes.forEach(node => {
                layout.push({
                    symbol: node.id, 
                    x: node.x, y: node.y, w: node.w, h: node.h
                });
            });
            localStorage.setItem('trader_dashboard_layout', JSON.stringify(layout));
        }

        function loadState() {
            const raw = localStorage.getItem('trader_dashboard_layout');
            if (!raw) return;
            try {
                const layout = JSON.parse(raw);
                layout.forEach(item => {
                    if(item.symbol) addSymbolWidget(item.symbol, item);
                });
            } catch (e) {
                console.error("Failed to load state", e);
            }
        }
    </script>
</body>
</html>